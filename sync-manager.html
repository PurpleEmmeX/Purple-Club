<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purple Club - Sistema Unificato di Sincronizzazione</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a2e 50%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #8b5cf6, #06b6d4);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: rgba(42, 42, 42, 0.8);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .panel h2 {
            color: #8b5cf6;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #8b5cf6;
            transition: all 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
        }
        
        .status-card.success {
            border-left-color: #10b981;
        }
        
        .status-card.warning {
            border-left-color: #f59e0b;
        }
        
        .status-card.error {
            border-left-color: #ef4444;
        }
        
        .status-card h3 {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }
        
        .status-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: linear-gradient(45deg, #8b5cf6, #06b6d4);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn.danger {
            background: linear-gradient(45deg, #ef4444, #dc2626);
        }
        
        .btn.success {
            background: linear-gradient(45deg, #10b981, #059669);
        }
        
        .logs-panel {
            grid-column: 1 / -1;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #8b5cf6;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .log-entry.success {
            border-left-color: #10b981;
        }
        
        .log-entry.warning {
            border-left-color: #f59e0b;
        }
        
        .log-entry.error {
            border-left-color: #ef4444;
        }
        
        .log-entry .timestamp {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
        }
        
        .events-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .event-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 3px solid #8b5cf6;
        }
        
        .event-item.missing {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .event-item h4 {
            color: #fff;
            margin-bottom: 5px;
        }
        
        .event-item p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #8b5cf6, #06b6d4);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2a2a2a;
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            max-width: 500px;
            width: 90%;
        }
        
        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Purple Club - Sistema Unificato</h1>
            <p>Gestione completa della sincronizzazione eventi e database</p>
        </div>
        
        <div class="dashboard">
            <!-- Status Panel -->
            <div class="panel">
                <h2>üìä Status Sistema</h2>
                <div class="status-grid">
                    <div class="status-card" id="localStorage-status">
                        <h3>LocalStorage</h3>
                        <div class="value" id="localStorage-count">-</div>
                    </div>
                    <div class="status-card" id="firebase-status">
                        <h3>Firebase</h3>
                        <div class="value" id="firebase-count">-</div>
                    </div>
                    <div class="status-card" id="sync-status">
                        <h3>Sincronizzazione</h3>
                        <div class="value" id="sync-state">-</div>
                    </div>
                    <div class="status-card" id="connection-status">
                        <h3>Connessione</h3>
                        <div class="value" id="connection-state">-</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn" onclick="refreshStatus()">
                        <span>üîÑ</span> Aggiorna Status
                    </button>
                    <button class="btn secondary" onclick="showDetails()">
                        <span>üìã</span> Dettagli Sistema
                    </button>
                </div>
            </div>
            
            <!-- Actions Panel -->
            <div class="panel">
                <h2>‚ö° Azioni Rapide</h2>
                <div class="controls">
                    <button class="btn success" onclick="autoSync()" id="autoSyncBtn">
                        <span>üöÄ</span> Sincronizzazione Auto
                    </button>
                    <button class="btn" onclick="manualSync()" id="manualSyncBtn">
                        <span>üîÑ</span> Sincronizzazione Manuale
                    </button>
                    <button class="btn secondary" onclick="testConnection()">
                        <span>üîç</span> Test Connessione
                    </button>
                    <button class="btn secondary" onclick="toggleOfflineMode()" id="offlineModeBtn">
                        <span>üì°</span> Modalit√† Offline
                    </button>
                    <button class="btn info" onclick="toggleTestMode()" id="testModeBtn">
                        <span>üß™</span> Modalit√† Test
                    </button>
                    <button class="btn danger" onclick="clearTestEvents()" id="clearTestBtn">
                        <span>üóëÔ∏è</span> Elimina Eventi Test
                    </button>
                    <button class="btn secondary" onclick="exportData()">
                        <span>üì§</span> Esporta Dati
                    </button>
                    <button class="btn danger" onclick="clearData()">
                        <span>üóëÔ∏è</span> Pulisci Cache
                    </button>
                </div>
                
                <div class="progress-bar" id="progressBar" style="display: none;">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <!-- Events Panel -->
            <div class="panel">
                <h2>üìÖ Eventi LocalStorage</h2>
                <div class="events-list" id="localEventsList">
                    <p>Caricamento eventi...</p>
                </div>
            </div>
            
            <!-- Firebase Events Panel -->
            <div class="panel">
                <h2>‚òÅÔ∏è Eventi Firebase</h2>
                <div class="events-list" id="firebaseEventsList">
                    <p>Caricamento eventi...</p>
                </div>
            </div>
            
            <!-- Logs Panel -->
            <div class="panel logs-panel">
                <h2>üìã Log Sistema</h2>
                <div class="controls">
                    <button class="btn secondary" onclick="clearLogs()">
                        <span>üóëÔ∏è</span> Pulisci Log
                    </button>
                    <button class="btn secondary" onclick="exportLogs()">
                        <span>üì§</span> Esporta Log
                    </button>
                </div>
                <div id="logsContainer">
                    <!-- I log verranno inseriti qui -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal per dettagli -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>üìä Dettagli Sistema</h2>
            <div id="detailsContent"></div>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            addDoc,
            query,
            orderBy,
            deleteDoc,
            doc,
            connectFirestoreEmulator,
            enableNetwork,
            disableNetwork
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { 
            getAuth, 
            signInAnonymously 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDONUlWkpq-0ZMPPmigQ6gczz2ghfem1hU",
            authDomain: "purple-club-d6080.firebaseapp.com",
            projectId: "purple-club-d6080",
            storageBucket: "purple-club-d6080.firebasestorage.app",
            messagingSenderId: "113484849723",
            appId: "1:113484849723:web:cde485c5028fa829f9321e"
        };
        
        // Configurazione modalit√† test Firebase
        let isTestMode = false; // Imposta a false per modalit√† produzione
        const testModeConfig = {
            enablePersistence: false, // Disabilita persistenza in test
            experimentalForceLongPolling: true, // Forza long polling per evitare WebSocket
            ignoreUndefinedProperties: true, // Ignora propriet√† undefined
            merge: true // Merge automatico dei documenti
        };
        
        // Global variables
        let app, db, auth;
        let localEvents = [];
        let firebaseEvents = [];
        let isConnected = false;
        let syncInProgress = false;
        let forceOfflineMode = false;
        let networkEnabled = true;
        
        // Sistema di logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logsContainer');
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <div class="timestamp">[${timestamp}]</div>
                <div>${message}</div>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // Aggiorna status card
        function updateStatusCard(cardId, value, type = 'info') {
            const card = document.getElementById(cardId);
            if (!card) {
                console.warn(`Status card with ID '${cardId}' not found`);
                return;
            }
            
            const valueElement = card.querySelector('.value');
            if (!valueElement) {
                console.warn(`Value element not found in card '${cardId}'`);
                return;
            }
            
            valueElement.textContent = value;
            card.className = `status-card ${type}`;
        }
        
        // Aggiorna barra di progresso
        function updateProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            if (percentage > 0) {
                progressBar.style.display = 'block';
                progressFill.style.width = `${percentage}%`;
            } else {
                progressBar.style.display = 'none';
            }
        }
        
        // Inizializza Firebase con configurazione specifica per modalit√† test
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                
                // Configurazione Firestore specifica per modalit√† test
                if (isTestMode) {
                    log('üß™ Modalit√† test Firebase attivata', 'info');
                    
                    // Configurazione Firestore per modalit√† test
                    db = getFirestore(app);
                    
                    // Configurazioni specifiche per evitare ERR_ABORTED in test
                    try {
                        // Disabilita persistenza offline per evitare conflitti
                        await disableNetwork(db);
                        log('üîß Persistenza offline disabilitata (modalit√† test)', 'info');
                        
                        // Riabilita con delay maggiore per modalit√† test
                        setTimeout(async () => {
                            try {
                                await enableNetwork(db);
                                log('üåê Rete riabilitata per modalit√† test', 'info');
                                
                                // Test di connessione specifico per modalit√† test
                                setTimeout(() => {
                                    performTestModeConnection();
                                }, 1000);
                            } catch (netError) {
                                log('‚ö†Ô∏è Rete non disponibile, modalit√† offline permanente', 'warning');
                                forceOfflineMode = true;
                            }
                        }, 3000); // Delay maggiore per modalit√† test
                    } catch (networkError) {
                        log('‚ö†Ô∏è Configurazione rete test non disponibile', 'warning');
                    }
                } else {
                    // Configurazione produzione
                    db = getFirestore(app);
                    log('üöÄ Modalit√† produzione Firebase', 'info');
                }
                
                auth = getAuth(app);
                
                // Autenticazione con timeout esteso per modalit√† test
                const authTimeout = isTestMode ? 10000 : 5000;
                try {
                    const authPromise = signInAnonymously(auth);
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout autenticazione')), authTimeout)
                    );
                    
                    await Promise.race([authPromise, timeoutPromise]);
                    log('‚úÖ Autenticazione completata', 'success');
                } catch (authError) {
                    log(`‚ö†Ô∏è Autenticazione fallita (${isTestMode ? 'test' : 'prod'}): ${authError.message}`, 'warning');
                }
                
                // Inizializzazione completata
                 log(`üîó Firebase inizializzato (modalit√†: ${isTestMode ? 'test' : 'produzione'})`, 'info');
                 isConnected = true;
                 
                 return true;
                 
             } catch (initError) {
                 log(`‚ùå Errore inizializzazione Firebase: ${initError.message}`, 'error');
                 isConnected = false;
                 updateStatusCard('connection-status', '‚ùå Errore Init', 'error');
                 return false;
             }
         }
         
         // Test di connessione specifico per modalit√† test
         async function performTestModeConnection() {
             if (!isTestMode) return;
             
             log('üß™ Esecuzione test connessione modalit√† test...', 'info');
             
             try {
                 // Test molto semplice per modalit√† test
                 const eventsRef = collection(db, 'events');
                 log('‚úÖ Riferimento collection creato (modalit√† test)', 'success');
                 
                 // Test lettura con timeout esteso per modalit√† test
                 try {
                     const testQuery = getDocs(eventsRef);
                     const testTimeout = new Promise((_, reject) => 
                         setTimeout(() => reject(new Error('Timeout test modalit√† test')), 15000)
                     );
                     
                     await Promise.race([testQuery, testTimeout]);
                     log('‚úÖ Test lettura modalit√† test completato', 'success');
                     updateStatusCard('connection-status', '‚úÖ Test OK', 'success');
                     
                 } catch (readError) {
                     if (readError.message.includes('ERR_ABORTED')) {
                         log('üß™ ERR_ABORTED in modalit√† test - attivazione offline automatica', 'warning');
                         forceOfflineMode = true;
                         const btn = document.getElementById('offlineModeBtn');
                         if (btn) {
                             btn.innerHTML = '<span>üîå</span> Modalit√† Online';
                             btn.className = 'btn warning';
                         }
                         updateStatusCard('connection-status', 'üß™ Test Offline', 'warning');
                     } else {
                         log(`‚ö†Ô∏è Test lettura modalit√† test fallito: ${readError.message}`, 'warning');
                     }
                 }
                 
             } catch (error) {
                 log(`‚ùå Errore test modalit√† test: ${error.message}`, 'error');
                 updateStatusCard('connection-status', '‚ùå Test Fallito', 'error');
             }
         }
        
        // Carica eventi da localStorage
        function loadLocalStorageEvents() {
            try {
                const stored = localStorage.getItem('purpleClubEvents');
                localEvents = stored ? JSON.parse(stored) : [];
                
                updateStatusCard('localStorage-count', localEvents.length, 
                    localEvents.length > 0 ? 'success' : 'warning');
                
                displayLocalEvents();
                log(`Caricati ${localEvents.length} eventi da localStorage`, 'info');
                return localEvents;
            } catch (error) {
                updateStatusCard('localStorage-count', 'Errore', 'error');
                log(`Errore localStorage: ${error.message}`, 'error');
                return [];
            }
        }
        
        // Carica eventi da Firebase con controllo modalit√† offline
        async function loadFirebaseEvents(retryCount = 0) {
            // Controlla modalit√† offline forzata
            if (forceOfflineMode) {
                log('üì° Modalit√† offline attiva - saltando caricamento Firebase', 'info');
                firebaseEvents = [];
                displayFirebaseEvents();
                updateStatusCard('firebase-count', 0, 'warning');
                return [];
            }
            
            if (!isConnected && retryCount === 0) {
                updateStatusCard('firebase-count', 'Offline', 'error');
                return [];
            }
            
            try {
                // Evita operazioni di rete se la rete √® disabilitata
                if (!networkEnabled) {
                    log('üîå Rete Firebase disabilitata - operazione saltata', 'info');
                    firebaseEvents = [];
                    displayFirebaseEvents();
                    updateStatusCard('firebase-count', 0, 'warning');
                    return [];
                }
                
                const eventsRef = collection(db, 'events');
                const q = query(eventsRef, orderBy('date', 'asc'));
                
                // Timeout molto breve per evitare ERR_ABORTED
                const queryPromise = getDocs(q);
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout preventivo (5s)')), 5000)
                );
                
                const querySnapshot = await Promise.race([queryPromise, timeoutPromise]);
                
                firebaseEvents = [];
                querySnapshot.forEach((doc) => {
                    firebaseEvents.push({ id: doc.id, ...doc.data() });
                });
                
                updateStatusCard('firebase-count', firebaseEvents.length, 
                    firebaseEvents.length > 0 ? 'success' : 'warning');
                
                displayFirebaseEvents();
                log(`Caricati ${firebaseEvents.length} eventi da Firebase`, 'info');
                return firebaseEvents;
            } catch (error) {
                const errorMsg = error.message || error.toString();
                
                // Gestione specifica per ERR_ABORTED e errori di rete
                if (errorMsg.includes('ERR_ABORTED') || errorMsg.includes('network') || errorMsg.includes('fetch')) {
                    log(`üîå Errore di rete Firebase rilevato: ${errorMsg}`, 'warning');
                    log('üì° Attivazione automatica modalit√† offline per prevenire ulteriori errori', 'info');
                    
                    // Attiva automaticamente modalit√† offline
                    forceOfflineMode = true;
                    const btn = document.getElementById('offlineModeBtn');
                    if (btn) {
                        btn.innerHTML = '<span>üîå</span> Modalit√† Online';
                        btn.className = 'btn warning';
                    }
                    
                    isConnected = false;
                    updateStatusCard('connection-status', 'üì° Offline Auto', 'warning');
                    
                    // Disabilita rete Firebase
                    if (db && networkEnabled) {
                        try {
                            disableNetwork(db);
                            networkEnabled = false;
                            log('üîå Rete Firebase disabilitata automaticamente', 'info');
                        } catch (disableError) {
                            log('‚ö†Ô∏è Impossibile disabilitare rete Firebase', 'warning');
                        }
                    }
                    
                    firebaseEvents = [];
                    displayFirebaseEvents();
                    updateStatusCard('firebase-count', 0, 'warning');
                    return [];
                }
                
                // Altri errori - retry limitato
                if (retryCount < 1) {
                    const delay = 2000;
                    log(`üîÑ Retry caricamento Firebase in ${delay/1000}s`, 'info');
                    setTimeout(() => loadFirebaseEvents(retryCount + 1), delay);
                    return [];
                }
                
                updateStatusCard('firebase-count', 'Errore', 'error');
                
                log(`‚ùå Errore Firebase dopo ${retryCount + 1} tentativi: ${errorMsg}`, 'error');
                isConnected = false;
                updateStatusCard('connection-status', '‚ùå Offline', 'error');
                
                return [];
            }
        }
        
        // Mostra eventi localStorage
        function displayLocalEvents() {
            const container = document.getElementById('localEventsList');
            
            if (localEvents.length === 0) {
                container.innerHTML = '<p>Nessun evento nel localStorage</p>';
                return;
            }
            
            container.innerHTML = localEvents.map(event => `
                <div class="event-item">
                    <h4>${event.title || 'Senza titolo'}</h4>
                    <p>Artista: ${event.artist || 'N/A'}</p>
                    <p>Data: ${event.date || 'N/A'}</p>
                    <p>ID: ${event.id || 'N/A'}</p>
                </div>
            `).join('');
        }
        
        // Mostra eventi Firebase
        function displayFirebaseEvents() {
            const container = document.getElementById('firebaseEventsList');
            
            if (firebaseEvents.length === 0) {
                container.innerHTML = '<p>Nessun evento su Firebase</p>';
                return;
            }
            
            container.innerHTML = firebaseEvents.map(event => `
                <div class="event-item">
                    <h4>${event.title || 'Senza titolo'}</h4>
                    <p>Artista: ${event.artist || 'N/A'}</p>
                    <p>Data: ${event.date || 'N/A'}</p>
                    <p>Status: ${event.status || 'N/A'}</p>
                    <p>ID Firebase: ${event.id}</p>
                </div>
            `).join('');
        }
        
        // Analizza sincronizzazione
        function analyzeSyncStatus() {
            const missingInFirebase = localEvents.filter(localEvent => {
                return !firebaseEvents.some(firebaseEvent => 
                    firebaseEvent.title === localEvent.title && 
                    firebaseEvent.date === localEvent.date
                );
            });
            
            if (missingInFirebase.length === 0) {
                updateStatusCard('sync-state', '‚úÖ Sync', 'success');
                log('Tutti gli eventi sono sincronizzati', 'success');
            } else {
                updateStatusCard('sync-state', `‚ö†Ô∏è ${missingInFirebase.length}`, 'warning');
                log(`${missingInFirebase.length} eventi da sincronizzare`, 'warning');
            }
            
            return missingInFirebase;
        }
        
        // Sincronizzazione automatica con controllo modalit√† offline
        async function performAutoSync() {
            if (syncInProgress) {
                log('Sincronizzazione gi√† in corso', 'warning');
                return;
            }
            
            syncInProgress = true;
            const autoSyncBtn = document.getElementById('autoSyncBtn');
            autoSyncBtn.disabled = true;
            autoSyncBtn.innerHTML = '<span class="spinner"></span> Sincronizzazione...';
            
            try {
                log('üöÄ Inizio sincronizzazione automatica', 'info');
                
                // Controlla modalit√† offline forzata
                if (forceOfflineMode) {
                    log('üì° Modalit√† offline forzata - sincronizzazione rimandata', 'warning');
                    updateStatusCard('sync-state', 'üì° Offline Forzato', 'warning');
                    
                    // Salva indicazione di sincronizzazione differita
                    const pendingSync = {
                        timestamp: new Date().toISOString(),
                        eventCount: localEvents.length,
                        status: 'forced_offline'
                    };
                    localStorage.setItem('purpleClubPendingSync', JSON.stringify(pendingSync));
                    log('üíæ Sincronizzazione differita (modalit√† offline forzata)', 'info');
                    return;
                }
                
                // Verifica connessione
                if (!isConnected) {
                    log('üîÑ Tentativo riconnessione Firebase...', 'info');
                    const connected = await initializeFirebase();
                    if (!connected) {
                        log('‚ö†Ô∏è Modalit√† offline attiva - sincronizzazione rimandata', 'warning');
                        updateStatusCard('sync-state', '‚ö†Ô∏è Offline', 'warning');
                        
                        // Salva indicazione di sincronizzazione differita
                        const pendingSync = {
                            timestamp: new Date().toISOString(),
                            eventCount: localEvents.length,
                            status: 'auto_offline'
                        };
                        localStorage.setItem('purpleClubPendingSync', JSON.stringify(pendingSync));
                        log('üíæ Sincronizzazione differita (modalit√† offline automatica)', 'info');
                        return;
                    }
                }
                
                // Carica dati aggiornati
                loadLocalStorageEvents();
                await loadFirebaseEvents();
                
                // Trova eventi da sincronizzare
                const missingEvents = analyzeSyncStatus();
                
                if (missingEvents.length === 0) {
                    log('‚úÖ Nessun evento da sincronizzare', 'success');
                    return;
                }
                
                log(`üì§ Sincronizzazione di ${missingEvents.length} eventi...`, 'info');
                
                let syncedCount = 0;
                for (let i = 0; i < missingEvents.length; i++) {
                    const event = missingEvents[i];
                    
                    try {
                        const { id, ...eventData } = event;
                        eventData.syncedAt = new Date().toISOString();
                        eventData.syncedFrom = 'localStorage';
                        
                        // Timeout per ogni operazione di scrittura
                        const addPromise = addDoc(collection(db, 'events'), eventData);
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout scrittura evento')), 10000)
                        );
                        
                        await Promise.race([addPromise, timeoutPromise]);
                        syncedCount++;
                        
                        const progress = ((i + 1) / missingEvents.length) * 100;
                        updateProgress(progress);
                        
                        log(`‚úÖ Sincronizzato: ${event.title}`, 'success');
                    } catch (error) {
                        if (error.message.includes('ERR_ABORTED') || error.message.includes('net::')) {
                            log(`‚ùå Connessione persa durante sincronizzazione ${event.title}`, 'error');
                            log('üì° Attivazione automatica modalit√† offline', 'warning');
                            
                            // Attiva automaticamente modalit√† offline
                            forceOfflineMode = true;
                            const btn = document.getElementById('offlineModeBtn');
                            if (btn) {
                                btn.innerHTML = '<span>üîå</span> Modalit√† Online';
                                btn.className = 'btn warning';
                            }
                            
                            isConnected = false;
                            updateStatusCard('connection-status', 'üì° Offline Auto', 'warning');
                            break;
                        } else {
                            log(`‚ùå Errore sincronizzazione ${event.title}: ${error.message}`, 'error');
                        }
                    }
                }
                
                if (isConnected && !forceOfflineMode) {
                    log(`üéâ Sincronizzazione completata: ${syncedCount}/${missingEvents.length} eventi`, 'success');
                    // Aggiorna dati
                    await loadFirebaseEvents();
                    analyzeSyncStatus();
                } else {
                    log(`‚ö†Ô∏è Sincronizzazione interrotta: ${syncedCount}/${missingEvents.length} eventi sincronizzati`, 'warning');
                }
                
            } catch (error) {
                if (error.message.includes('ERR_ABORTED') || error.message.includes('net::')) {
                    log('‚ùå Connessione Firebase persa durante sincronizzazione', 'error');
                    log('üì° Attivazione automatica modalit√† offline', 'warning');
                    
                    // Attiva automaticamente modalit√† offline
                    forceOfflineMode = true;
                    const btn = document.getElementById('offlineModeBtn');
                    if (btn) {
                        btn.innerHTML = '<span>üîå</span> Modalit√† Online';
                        btn.className = 'btn warning';
                    }
                    
                    isConnected = false;
                    updateStatusCard('connection-status', 'üì° Offline Auto', 'warning');
                } else {
                    log(`‚ùå Errore sincronizzazione: ${error.message}`, 'error');
                }
            } finally {
                syncInProgress = false;
                autoSyncBtn.disabled = false;
                autoSyncBtn.innerHTML = '<span>üöÄ</span> Sincronizzazione Auto';
                updateProgress(0);
            }
        }
        
        // Test connessione sicuro senza operazioni che causano ERR_ABORTED
        async function performTestConnection() {
            log('üîç Test connessione sicuro in corso...', 'info');
            
            try {
                // Test solo inizializzazione senza operazioni di rete
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                }
                
                // Test creazione collection reference (operazione locale)
                const eventsRef = collection(db, 'events');
                log('‚úÖ Riferimento database creato', 'success');
                
                // Test autenticazione con timeout molto breve
                try {
                    if (!auth.currentUser) {
                        const authPromise = signInAnonymously(auth);
                        const quickTimeout = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout rapido')), 3000)
                        );
                        await Promise.race([authPromise, quickTimeout]);
                        log('‚úÖ Autenticazione test completata', 'success');
                    }
                } catch (authError) {
                    log('‚ö†Ô∏è Test autenticazione saltato (timeout)', 'warning');
                }
                
                // Aggiorna stato senza operazioni di lettura rischiose
                isConnected = true;
                updateStatusCard('connection-status', '‚úÖ Testato', 'success');
                log('‚úÖ Test connessione completato senza errori', 'success');
                
            } catch (error) {
                isConnected = false;
                updateStatusCard('connection-status', '‚ùå Test Fallito', 'error');
                log(`‚ùå Test connessione fallito: ${error.message}`, 'error');
            }
        }
        
        // Esporta dati
        function performExportData() {
            const data = {
                timestamp: new Date().toISOString(),
                localStorage: localEvents,
                firebase: firebaseEvents,
                stats: {
                    localCount: localEvents.length,
                    firebaseCount: firebaseEvents.length,
                    connected: isConnected
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `purple-club-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('üì§ Dati esportati con successo', 'success');
        }
        
        // Pulisci cache
        function performClearData() {
            if (confirm('Sei sicuro di voler pulire la cache? Questa azione rimuover√† tutti i dati dal localStorage.')) {
                localStorage.removeItem('purpleClubEvents');
                localEvents = [];
                displayLocalEvents();
                updateStatusCard('localStorage-count', 0, 'warning');
                analyzeSyncStatus();
                log('üóëÔ∏è Cache pulita', 'info');
            }
        }
        
        // Funzioni globali
        window.refreshStatus = async function() {
            log('üîÑ Aggiornamento status...', 'info');
            loadLocalStorageEvents();
            await loadFirebaseEvents();
            analyzeSyncStatus();
        };
        
        window.autoSync = performAutoSync;
        window.manualSync = performAutoSync; // Stessa funzione per ora
        window.testConnection = performTestConnection;
        window.exportData = performExportData;
        window.clearData = performClearData;
        
        // Controllo modalit√† offline
        window.toggleOfflineMode = function() {
            forceOfflineMode = !forceOfflineMode;
            const btn = document.getElementById('offlineModeBtn');
            
            if (forceOfflineMode) {
                btn.innerHTML = '<span>üîå</span> Modalit√† Online';
                btn.className = 'btn warning';
                updateStatusCard('connection-status', 'üì° Offline Forzato', 'warning');
                log('üì° Modalit√† offline attivata manualmente', 'warning');
                isConnected = false;
                
                // Disabilita rete Firebase se possibile
                if (db && networkEnabled) {
                    try {
                        disableNetwork(db);
                        networkEnabled = false;
                        log('üîå Rete Firebase disabilitata', 'info');
                    } catch (error) {
                        log('‚ö†Ô∏è Impossibile disabilitare rete Firebase', 'warning');
                    }
                }
            } else {
                btn.innerHTML = '<span>üì°</span> Modalit√† Offline';
                btn.className = 'btn secondary';
                updateStatusCard('connection-status', 'üîå Tentativo Riconnessione', 'info');
                log('üîå Modalit√† online riattivata', 'info');
                
                // Riabilita rete Firebase
                if (db && !networkEnabled) {
                    try {
                        enableNetwork(db);
                        networkEnabled = true;
                        log('üì° Rete Firebase riabilitata', 'success');
                        // Test connessione dopo riabilitazione
                        setTimeout(() => performTestConnection(), 1000);
                    } catch (error) {
                        log('‚ùå Errore riabilitazione rete Firebase', 'error');
                    }
                }
            }
        };
        
        // Controllo modalit√† test Firebase
        window.toggleTestMode = function() {
            const btn = document.getElementById('testModeBtn');
            
            if (isTestMode) {
                // Passa a modalit√† produzione
                window.isTestMode = false;
                btn.innerHTML = '<span>üöÄ</span> Modalit√† Produzione';
                btn.className = 'btn success';
                log('üöÄ Passaggio a modalit√† produzione Firebase', 'info');
                
                // Reinizializza Firebase in modalit√† produzione
                setTimeout(async () => {
                    log('üîÑ Reinizializzazione Firebase in modalit√† produzione...', 'info');
                    await initializeFirebase();
                    loadLocalStorageEvents();
                    await loadFirebaseEvents();
                    analyzeSyncStatus();
                }, 1000);
                
            } else {
                // Passa a modalit√† test
                window.isTestMode = true;
                btn.innerHTML = '<span>üß™</span> Modalit√† Test';
                btn.className = 'btn info';
                log('üß™ Passaggio a modalit√† test Firebase', 'info');
                
                // Reinizializza Firebase in modalit√† test
                setTimeout(async () => {
                    log('üîÑ Reinizializzazione Firebase in modalit√† test...', 'info');
                    await initializeFirebase();
                    loadLocalStorageEvents();
                    await loadFirebaseEvents();
                    analyzeSyncStatus();
                }, 1000);
            }
            
            // Aggiorna indicatori UI
            updateTestModeIndicators();
        };
        
        // Aggiorna indicatori modalit√† test
         function updateTestModeIndicators() {
             const testBtn = document.getElementById('testModeBtn');
             if (testBtn) {
                 if (isTestMode) {
                     testBtn.innerHTML = '<span>üß™</span> Modalit√† Test';
                     testBtn.className = 'btn info';
                 } else {
                     testBtn.innerHTML = '<span>üöÄ</span> Modalit√† Produzione';
                     testBtn.className = 'btn success';
                 }
             }
         }
         
         // Elimina eventi di test dal database
         window.clearTestEvents = async function() {
             const button = document.getElementById('clearTestBtn');
             const originalText = button.innerHTML;
             
             try {
                 button.innerHTML = '<span>‚è≥</span> Eliminando...';
                 button.disabled = true;
                 
                 log('üîç Ricerca eventi di test in corso...', 'info');
                 
                 if (!db) {
                     throw new Error('Database non inizializzato');
                 }
                 
                 // Carica tutti gli eventi
                 const eventsRef = collection(db, 'events');
                 const querySnapshot = await getDocs(eventsRef);
                 
                 const allEvents = [];
                 querySnapshot.forEach((doc) => {
                     allEvents.push({ id: doc.id, ...doc.data() });
                 });
                 
                 log(`üìä Trovati ${allEvents.length} eventi totali`, 'info');
                 
                 // Filtra eventi di test
                 const testEvents = allEvents.filter(event => {
                     return (
                         (event.title && event.title.toLowerCase().includes('test')) ||
                         (event.artist && event.artist.toLowerCase().includes('test')) ||
                         (event.title && event.title.includes('Security')) ||
                         (event.artist && event.artist.toLowerCase().includes('security')) ||
                         (event.venue && event.venue.toLowerCase().includes('test'))
                     );
                 });
                 
                 if (testEvents.length === 0) {
                     log('‚ÑπÔ∏è Nessun evento di test trovato', 'info');
                     return;
                 }
                 
                 log(`üéØ Trovati ${testEvents.length} eventi di test da eliminare`, 'warning');
                 
                 let deletedCount = 0;
                 let errors = [];
                 
                 // Elimina eventi di test
                 for (let i = 0; i < testEvents.length; i++) {
                     const event = testEvents[i];
                     button.innerHTML = `<span>‚è≥</span> ${i + 1}/${testEvents.length}`;
                     
                     try {
                         await deleteDoc(doc(db, 'events', event.id));
                         deletedCount++;
                         log(`‚úÖ Eliminato: ${event.title || 'Senza titolo'}`, 'success');
                         
                         // Pausa per evitare sovraccarico
                         await new Promise(resolve => setTimeout(resolve, 100));
                     } catch (deleteError) {
                         errors.push(`${event.title}: ${deleteError.message}`);
                         log(`‚ùå Errore eliminazione: ${event.title}`, 'error');
                     }
                 }
                 
                 // Risultati finali
                 if (deletedCount > 0) {
                     log(`‚úÖ Eliminati ${deletedCount} eventi di test!`, 'success');
                     
                     // Ricarica eventi dopo eliminazione
                     setTimeout(async () => {
                         await loadFirebaseEvents();
                         loadLocalStorageEvents();
                         analyzeSyncStatus();
                     }, 1000);
                 }
                 
                 if (errors.length > 0) {
                     log(`‚ö†Ô∏è ${errors.length} errori durante l'eliminazione`, 'warning');
                 }
                 
             } catch (error) {
                 log(`‚ùå Errore eliminazione eventi test: ${error.message}`, 'error');
             } finally {
                 button.innerHTML = originalText;
                 button.disabled = false;
             }
         }
        
        window.clearLogs = function() {
            document.getElementById('logsContainer').innerHTML = '';
        };
        
        window.exportLogs = function() {
            const logs = Array.from(document.querySelectorAll('.log-entry')).map(entry => entry.textContent);
            const blob = new Blob([logs.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `purple-club-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        };
        
        window.showDetails = function() {
            const details = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href,
                localStorage: {
                    available: typeof(Storage) !== 'undefined',
                    events: localEvents.length
                },
                firebase: {
                    connected: isConnected,
                    events: firebaseEvents.length
                },
                sync: {
                    inProgress: syncInProgress
                }
            };
            
            document.getElementById('detailsContent').innerHTML = `<pre>${JSON.stringify(details, null, 2)}</pre>`;
            document.getElementById('detailsModal').style.display = 'block';
        };
        
        window.closeModal = function() {
            document.getElementById('detailsModal').style.display = 'none';
        };
        
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', async () => {
            log('üöÄ Sistema Unificato Purple Club avviato', 'success');
            
            // Inizializza indicatori modalit√† test
            updateTestModeIndicators();
            
            // Inizializza Firebase
            await initializeFirebase();
            
            // Carica dati iniziali
            loadLocalStorageEvents();
            await loadFirebaseEvents();
            analyzeSyncStatus();
            
            log('‚úÖ Inizializzazione completata', 'success');
        });
        
        // Fallback per assicurarsi che l'inizializzazione avvenga
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', async () => {
                // Gi√† gestito sopra
            });
        } else {
            // DOM gi√† caricato, inizializza immediatamente
            setTimeout(async () => {
                log('üöÄ Sistema Unificato Purple Club avviato (fallback)', 'success');
                updateTestModeIndicators();
                await initializeFirebase();
                loadLocalStorageEvents();
                await loadFirebaseEvents();
                analyzeSyncStatus();
                log('‚úÖ Inizializzazione completata (fallback)', 'success');
            }, 100);
        }
        
        // Chiudi modal cliccando fuori
        window.onclick = function(event) {
            const modal = document.getElementById('detailsModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
    </script>
</body>
</html>